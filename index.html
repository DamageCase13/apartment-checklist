<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Apartment Renovation Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Warm Neutrals (Slate, Stone, Amber) -->
    <!-- Application Structure Plan: A multi-building, multi-unit task-oriented dashboard design was chosen. It features a main header, a hierarchical selection area (Building then Unit), a dynamic summary/dashboard section, category-based filters, and an interactive list of checklist items. A chart provides a visual summary of the currently selected unit's progress. This structure is designed for property managers or owners to efficiently switch between and manage hundreds of units across multiple buildings. Firestore integration ensures data persistence and real-time updates across multiple sessions and users. The task-focused flow directly supports the user's goal of organizing and completing renovation work for an entire portfolio of properties. -->
    <!-- Visualization & Content Choices: 
        - Building Selection -> Goal: Organize/Navigate -> Presentation: Dropdown and Add Building Button -> Interaction: Selects building, loads its units; button adds new building. -> Justification: Essential for managing distinct groups of units (buildings). -> Method: HTML/CSS/JS with Firestore.
        - Unit Selection (per building) -> Goal: Organize/Navigate -> Presentation: Dropdown and Add Unit Button -> Interaction: Selects unit, loads its data; button adds new unit to selected building. -> Justification: Essential for managing individual unit data within a building. -> Method: HTML/CSS/JS with Firestore.
        - Checklist Data (per unit) -> Goal: Organize/Interact -> Presentation: Interactive Cards -> Interaction: Users can change status, priority, and add costs/notes via dropdowns and inputs, triggering Firestore updates. -> Justification: Transforms a passive list into an active management tool for each unit. -> Method: HTML/CSS/JS with Firestore.
        - Summary Stats (per unit) -> Goal: Inform -> Presentation: Dynamic Stat Cards -> Interaction: Numbers update automatically as item statuses change for the current unit. -> Justification: Provides an at-a- glance overview of the current unit's project progress and cost. -> Method: HTML/JS with Firestore data.
        - Task Status Breakdown (per unit) -> Goal: Compare/Inform -> Presentation: Donut Chart -> Interaction: Chart updates in real-time when an item's status is changed for the current unit. -> Justification: Offers a quick, visual representation of current unit's completion. -> Library: Chart.js (Canvas).
        - Gemini API Integration -> Goal: Enhance Planning/Brainstorming -> Presentation: AI-generated text suggestions -> Interaction: Buttons trigger LLM calls for renovation ideas and expanded notes, applicable to the current item. -> Justification: Provides creative and practical assistance for renovation tasks within any selected unit. -> Method: HTML/CSS/JS with Gemini API calls.
        - Custom Modal System -> Goal: User Feedback/Input -> Presentation: Overlay Dialog -> Interaction: Replaces native browser alerts/prompts for consistent UI and better control over user input. -> Justification: Improves user experience and reliability in various environments. -> Method: HTML/CSS/JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .item-card.done {
            opacity: 0.6;
        }
        .item-card.done .item-description {
            text-decoration: line-through;
        }
        .gemini-response {
            background-color: #e0f2fe; /* light blue for AI response */
            border-left: 4px solid #3b82f6; /* blue-500 */
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #1e40af; /* blue-800 */
            white-space: pre-wrap;
            word-break: break-word;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Modal Styles */
        #custom-modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        #custom-modal > div {
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #custom-modal.hidden > div {
            transform: translateY(-50px);
            opacity: 0;
        }
        #custom-modal.hidden {
            opacity: 0;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-slate-900">Apartment Renovation Checklist</h1>
            <p class="mt-2 text-lg text-slate-600">Manage renovations across all your buildings and units.</p>
        </header>

        <main>
            <section id="building-selection-section" class="mb-8 p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                <h2 class="text-2xl font-bold mb-4 text-slate-800">Select Building</h2>
                <p class="text-slate-600 mb-6">Choose a building from the dropdown or add a new one to get started. Default buildings will be added if none exist.</p>
                <div id="building-selector-container" class="flex flex-wrap items-center gap-4 hidden">
                    <select id="building-select" class="p-2 border rounded-md bg-white text-base flex-grow max-w-xs"></select>
                    <button id="add-building-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">Add New Building</button>
                    <p class="text-slate-600 ml-auto">Current: <span id="current-selection-display" class="font-semibold text-slate-900"></span></p>
                </div>
                <div id="add-building-section" class="hidden text-center py-4">
                    <p class="text-slate-500">No buildings found. Adding default buildings...</p>
                    <!-- This section will be hidden once default buildings are added -->
                </div>
            </section>

            <section id="unit-selection-section" class="mb-8 p-6 bg-white rounded-xl shadow-sm border border-slate-200 hidden">
                <h2 class="text-2xl font-bold mb-4 text-slate-800">Select Unit</h2>
                <p class="text-slate-600 mb-6">Choose an existing unit from the dropdown or add a new one for the selected building.</p>
                <div id="unit-selector-container" class="flex flex-wrap items-center gap-4 hidden">
                    <select id="unit-select" class="p-2 border rounded-md bg-white text-base flex-grow max-w-xs"></select>
                    <button id="add-unit-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">Add New Unit</button>
                </div>
                <div id="add-unit-section" class="hidden text-center py-4">
                    <p class="text-slate-500">No units found for this building. Click "Add New Unit" to create your first unit!</p>
                    <button id="add-unit-btn-placeholder" class="mt-4 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-lg">Add Your First Unit</button>
                </div>
            </section>

            <section id="checklist-section" class="hidden">
                <section id="dashboard" class="mb-8 p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">Project Dashboard</h2>
                    <p class="text-slate-600 mb-6">This dashboard provides a real-time summary of the currently selected unit's renovation project. As you update the status and costs of items in the checklist below, the figures and chart here will automatically adjust to reflect your progress.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="p-4 bg-slate-50 rounded-lg">
                            <h3 class="text-sm font-medium text-slate-500">Total Items</h3>
                            <p id="total-items" class="text-3xl font-semibold text-slate-900">0</p>
                        </div>
                        <div class="p-4 bg-amber-50 rounded-lg">
                            <h3 class="text-sm font-medium text-amber-600">Pending Items</h3>
                            <p id="pending-items" class="text-3xl font-semibold text-amber-800">0</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg">
                            <h3 class="text-sm font-medium text-green-600">Completed Items</h3>
                            <p id="completed-items" class="text-3xl font-semibold text-green-800">0</p>
                        </div>
                        <div class="p-4 bg-stone-50 rounded-lg">
                            <h3 class="text-sm font-medium text-stone-600">Total Est. Cost</h3>
                            <p id="total-cost" class="text-3xl font-semibold text-stone-800">$0</p>
                        </div>
                        <div class="md:col-span-2 lg:col-span-4 p-4 bg-white rounded-lg">
                            <div class="chart-container">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="checklist" class="p-6 bg-white rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold mb-4 text-slate-800">Checklist Items</h2>
                    <p class="text-slate-600 mb-6">Use the filters to focus on specific areas of the apartment. You can update the Status, Priority, Cost, and Notes for each item directly. Your changes will be instantly reflected in the dashboard above. Also, try the new ✨ buttons for AI-powered suggestions!</p>
                    <div id="filters" class="flex flex-wrap gap-2 mb-6">
                        <button id="add-custom-item-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Add Custom Item</button>
                    </div>
                    <div id="checklist-items" class="space-y-4">
                    </div>
                </section>
            </section>
        </main>

    </div>

    <!-- Custom Modal HTML -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <p id="modal-message" class="text-lg font-semibold mb-4 text-center"></p>
            <input type="text" id="modal-input-1" class="w-full p-2 border rounded-md mb-2 hidden" placeholder="Input 1">
            <input type="text" id="modal-input-2" class="w-full p-2 border rounded-md mb-2 hidden" placeholder="Input 2">
            <input type="text" id="modal-input-3" class="w-full p-2 border rounded-md mb-4 hidden" placeholder="Input 3">
            <div class="flex justify-end gap-2">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition hidden">Cancel</button>
                <button id="modal-ok-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and data
        window.app;
        window.db;
        window.auth;
        window.userId = null;
        window.selectedBuildingId = null;
        window.selectedUnitId = null;
        window.currentUnitChecklistData = [];
        window.buildings = []; // Stores { id: 'buildingId', name: 'Building Name' }
        window.units = []; // Stores { id: 'unitId', name: 'Unit Name' } for the selected building

        // Initialize global state variables
        window.currentFilter = 'All'; // Moved to global scope
        window.statusChart = null; // Explicitly null

        // Initial checklist template for new units
        window.initialChecklistTemplate = [
            { id: 1, area: 'Overall', item: 'Walls', issue: 'Cracks, holes, scuffs, outdated paint color', priority: 'Medium', cost: 0, notes: 'Patch, repaint', status: 'To Do' },
            { id: 2, area: 'Overall', item: 'Ceilings', issue: 'Water stains, cracks, peeling paint', priority: 'High', cost: 0, notes: 'Repair leaks, patch, repaint', status: 'To Do' },
            { id: 3, area: 'Overall', item: 'Flooring', issue: 'Scratches, wear, loose tiles, outdated carpet', priority: 'Medium', cost: 0, notes: 'Refinish or replace', status: 'To Do' },
            { id: 4, area: 'Overall', item: 'Lighting Fixtures', issue: 'Flickering, broken, outdated style', priority: 'Low', cost: 0, notes: 'Replace bulbs or upgrade fixtures', status: 'To Do' },
            { id: 5, area: 'Overall', item: 'Windows', issue: 'Drafts, broken seals, sticky, dirty', priority: 'Medium', cost: 0, notes: 'Re-caulk, repair, clean', status: 'To Do' },
            { id: 6, area: 'Overall', item: 'Doors', issue: 'Scratches, dents, sticky, broken hardware', priority: 'Low', cost: 0, notes: 'Repaint or replace hardware', status: 'To Do' },
            { id: 7, area: 'Overall', item: 'Outlets/Switches', issue: 'Loose, non-functional, outdated', priority: 'High', cost: 0, notes: 'Replace, ensure GFCI in wet areas', status: 'To Do' },
            { id: 8, area: 'Overall', item: 'Smoke/CO Detectors', issue: 'Missing, expired, non-functional', priority: 'High', cost: 0, notes: 'Install/replace, test', status: 'To Do' },
            { id: 9, area: 'Overall', item: 'HVAC/Vents', issue: 'Dirty, noisy, poor airflow', priority: 'Medium', cost: 0, notes: 'Clean, repair, replace filters', status: 'To Do' },
            { id: 10, area: 'Kitchen', item: 'Cabinets', issue: 'Scratches, loose hinges, outdated style', priority: 'Medium', cost: 0, notes: 'Repaint or replace hardware', status: 'To Do' },
            { id: 11, area: 'Kitchen', item: 'Countertops', issue: 'Stains, scratches, chips, outdated material', priority: 'High', cost: 0, notes: 'Resurface or replace', status: 'To Do' },
            { id: 12, area: 'Kitchen', item: 'Sink/Faucet', issue: 'Leaks, low pressure, rust, outdated', priority: 'High', cost: 0, notes: 'Repair leak, replace faucet', status: 'To Do' },
            { id: 13, area: 'Kitchen', item: 'Appliances', issue: 'Non-functional, outdated, dirty', priority: 'High', cost: 0, notes: 'Repair or replace', status: 'To Do' },
            { id: 14, area: 'Kitchen', item: 'Backsplash', issue: 'Missing, damaged, outdated', priority: 'Low', cost: 0, notes: 'Install new backsplash', status: 'To Do' },
            { id: 15, area: 'Bathroom', item: 'Toilet', issue: 'Leaking, wobbly, outdated', priority: 'High', cost: 0, notes: 'Repair or replace', status: 'To Do' },
            { id: 16, area: 'Bathroom', item: 'Sink/Vanity', issue: 'Leaks, cracks, outdated, poor storage', priority: 'Medium', cost: 0, notes: 'Repair or replace', status: 'To Do' },
            { id: 17, area: 'Bathroom', item: 'Shower/Tub', issue: 'Leaks, mold, cracks, outdated', priority: 'High', cost: 0, notes: 'Re-grout, re-caulk, resurface', status: 'To Do' },
            { id: 18, area: 'Bathroom', item: 'Tiles', issue: 'Cracked, missing, dirty grout', priority: 'Medium', cost: 0, notes: 'Replace or re-grout', status: 'To Do' },
            { id: 19, area: 'Bathroom', item: 'Exhaust Fan', issue: 'Noisy, non-functional', priority: 'Medium', cost: 0, notes: 'Clean or replace', status: 'To Do' },
            { id: 20, area: 'Bedrooms', item: 'Closets', issue: 'Damaged rods/shelves, poor lighting', priority: 'Low', cost: 0, notes: 'Repair and add organizers', status: 'To Do' },
            { id: 21, area: 'Other', item: 'Balcony/Patio', issue: 'Cracks, railing issues, dirty', priority: 'Medium', cost: 0, notes: 'Repair and power wash', status: 'To Do' },
        ];

        // Default buildings to add if none exist
        window.defaultBuildings = ['Building 300', 'Building 400', 'Building 340', 'Building 345'];

        // DOM element references (will be assigned on DOMContentLoaded)
        let buildingSelect;
        let addBuildingBtn;
        let buildingSelectorContainer;
        let addBuildingSection;
        let currentSelectionDisplay;

        let unitSelect;
        let addUnitBtn;
        let unitSelectorContainer;
        let addUnitSection;
        let addUnitBtnPlaceholder;

        let checklistSection;
        let totalItemsDisplay;
        let completedItemsDisplay;
        let pendingItemsDisplay;
        let totalCostDisplay;
        let statusChartCanvas;

        let filtersContainer;
        let checklistContainer;
        let addCustomItemBtn;

        let modalMessage;
        let modalInput1;
        let modalInput2;
        let modalInput3;
        let modalCancelBtn;
        let modalOkBtn;
        let customModal;

        // --- Global Functions (DEFINED FIRST) ---

        // Custom Modal Logic
        window.modalCallback = null; // Declare as window property

        window.showModal = function(message, type, inputPlaceholders = [], callback = null) {
            console.log("showModal: Displaying modal with message:", message);
            modalMessage.textContent = message;
            modalInput1.classList.add('hidden');
            modalInput2.classList.add('hidden');
            modalInput3.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');

            modalInput1.value = '';
            modalInput2.value = '';
            modalInput3.value = '';

            if (inputPlaceholders.length > 0) {
                modalInput1.classList.remove('hidden');
                modalInput1.placeholder = inputPlaceholders[0];
                if (inputPlaceholders[1]) {
                    modalInput2.classList.remove('hidden');
                    modalInput2.placeholder = inputPlaceholders[1];
                }
                if (inputPlaceholders[2]) {
                    modalInput3.classList.remove('hidden');
                    modalInput3.placeholder = inputPlaceholders[2];
                }
                modalCancelBtn.classList.remove('hidden');
            }

            window.modalCallback = callback; // Assign to window property
            customModal.classList.remove('hidden');
            console.log("showModal: Modal visible.");
        }

        window.hideModal = function() {
            console.log("hideModal: Hiding modal.");
            customModal.classList.add('hidden');
            window.modalCallback = null; // Assign to window property
            console.log("hideModal: Modal hidden.");
        }

        // Gemini API Call Function
        async function callGeminiAPI(prompt, elementId) {
            const responseDiv = document.getElementById(`gemini-response-${elementId}`);
            responseDiv.innerHTML = '<div class="loading-spinner"></div> Loading AI suggestions...';

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    responseDiv.innerHTML = text;
                } else {
                    responseDiv.innerHTML = 'Error: Could not get a response from AI. Please try again.';
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                responseDiv.innerHTML = 'Error: Failed to connect to AI. Please check your network and try again.';
            }
        }

        // Render Checklist Items
        window.renderChecklist = function() {
            console.log("renderChecklist: Starting...");
            if (!checklistContainer) {
                console.error("renderChecklist: checklistContainer is null. Cannot render.");
                return;
            }
            checklistContainer.innerHTML = '';
            const filteredData = window.currentUnitChecklistData.filter(item => window.currentFilter === 'All' || item.area === window.currentFilter); // Use window.currentFilter

            if (filteredData.length === 0) {
                checklistContainer.innerHTML = `<div class="text-center py-8 text-slate-500">No items match the current filter.</div>`;
                return;
            }

            filteredData.forEach(item => {
                const card = document.createElement('div');
                card.className = `item-card p-4 border rounded-lg grid grid-cols-1 md:grid-cols-12 gap-4 items-center transition-opacity ${item.status === 'Done' ? 'done' : ''} ${item.status === 'Done' ? 'bg-slate-50' : 'bg-white'}`;
                
                card.innerHTML = `
                    <div class="md:col-span-4">
                        <p class="font-bold text-slate-800">${item.item}</p>
                        <p class="text-sm text-slate-500 item-description">${item.issue}</p>
                    </div>
                    <div class="md:col-span-2">
                        <select data-id="${item.id}" data-field="status" class="w-full p-2 border rounded-md bg-white text-sm">
                            ${statusOptions.map(opt => `<option value="${opt}" ${item.status === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <select data-id="${item.id}" data-field="priority" class="w-full p-2 border rounded-md bg-white text-sm">
                            ${priorityOptions.map(opt => `<option value="${opt}" ${item.priority === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>
                    <div class="md:col-span-1">
                        <input type="number" data-id="${item.id}" data-field="cost" value="${item.cost}" class="w-full p-2 border rounded-md text-sm" placeholder="Cost">
                    </div>
                    <div class="md:col-span-3 flex flex-col gap-2">
                        <input type="text" data-id="${item.id}" data-field="notes" value="${item.notes}" class="w-full p-2 border rounded-md text-sm" placeholder="Notes...">
                        <div class="flex gap-2">
                            <button data-id="${item.id}" data-action="get-ideas" class="flex-1 px-3 py-1 bg-blue-500 text-white text-xs rounded-md hover:bg-blue-600 transition">✨ Get Ideas</button>
                            <button data-id="${item.id}" data-action="expand-notes" class="flex-1 px-3 py-1 bg-purple-500 text-white text-xs rounded-md hover:bg-purple-600 transition">✨ Expand Notes</button>
                        </div>
                    </div>
                    <div id="gemini-response-${item.id}" class="md:col-span-12 gemini-response hidden"></div>
                `;
                checklistContainer.appendChild(card);
            });
            console.log("renderChecklist: Completed.");
        }

        // Update Dashboard Summary
        window.updateDashboard = function() {
            console.log("updateDashboard: Starting...");
            if (!totalItemsDisplay || !completedItemsDisplay || !pendingItemsDisplay || !totalCostDisplay) {
                console.error("updateDashboard: Dashboard display elements are null. Cannot update.");
                return;
            }
            const totalItems = window.currentUnitChecklistData.length;
            const completedItems = window.currentUnitChecklistData.filter(item => item.status === 'Done').length;
            const pendingItems = totalItems - completedItems;
            const totalCost = window.currentUnitChecklistData.reduce((sum, item) => sum + Number(item.cost), 0);

            totalItemsDisplay.textContent = totalItems;
            completedItemsDisplay.textContent = completedItems;
            pendingItemsDisplay.textContent = pendingItems;
            totalCostDisplay.textContent = `$${totalCost.toLocaleString()}`;
            
            window.updateChart();
            console.log("updateDashboard: Completed.");
        }

        // Render Filter Buttons
        window.renderFilters = function() {
            console.log("renderFilters: Starting...");
            if (!filtersContainer || !addCustomItemBtn) {
                console.error("renderFilters: filtersContainer or addCustomItemBtn is null. Cannot render.");
                return;
            }
            // Dynamically get all unique areas from current data and initial template
            const allAreas = new Set(window.initialChecklistTemplate.map(item => item.area));
            window.currentUnitChecklistData.forEach(item => allAreas.add(item.area));

            const areas = ['All', ...Array.from(allAreas).sort()]; // Sort alphabetically

            // Clear existing filters except the "Add Custom Item" button
            // Re-append the button to ensure it's always there and at the start
            filtersContainer.innerHTML = ''; // Clear all
            filtersContainer.appendChild(addCustomItemBtn); // Add it back

            areas.forEach(area => {
                const button = document.createElement('button');
                button.dataset.filter = area;
                button.className = `filter-btn px-4 py-2 text-sm font-medium rounded-full transition ${window.currentFilter === area ? 'bg-slate-800 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`; // Use window.currentFilter
                button.textContent = area;
                filtersContainer.appendChild(button);
            });
            console.log("renderFilters: Completed.");
        }
        
        // Update Chart
        window.updateChart = function() {
            console.log("updateChart: Starting...");
            if (!statusChartCanvas) {
                console.error("updateChart: statusChartCanvas is null. Cannot update.");
                return;
            }

            const statusCounts = { 'To Do': 0, 'In Progress': 0, 'Done': 0 };
            window.currentUnitChecklistData.forEach(item => {
                statusCounts[item.status]++;
            });

            const data = {
                labels: Object.keys(statusCounts),
                datasets: [{
                    label: 'Task Status',
                    data: Object.values(statusCounts),
                    backgroundColor: [
                        'rgb(251 191 36)', // amber-400
                        'rgb(59 130 246)', // blue-500
                        'rgb(34 197 94)'  // green-500
                    ],
                    borderColor: '#f8fafc',
                    borderWidth: 4,
                    hoverOffset: 8
                }]
            };

            // Destroy existing chart instance if it exists before creating a new one
            if (window.statusChart) {
                window.statusChart.destroy();
                window.statusChart = null; // Clear reference
                console.log("updateChart: Existing chart destroyed.");
            }
            
            const ctx = statusChartCanvas.getContext('2d');
            window.statusChart = new Chart(ctx, { // Assign to window.statusChart
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    return label;
                                }
                            }
                        },
                        cutout: '60%'
                    }
                }
            });
            console.log("updateChart: New chart created.");
            console.log("updateChart: Completed.");
        }

        // Function to load buildings from Firestore
        async function loadBuildings() {
            console.log("loadBuildings: Starting...");
            if (!window.db || !window.userId) {
                console.log("loadBuildings: DB or userId not ready.");
                return;
            }

            const buildingsCollectionRef = collection(window.db, `artifacts/${window.appId}/users/${window.userId}/buildings`);
            try {
                const querySnapshot = await getDocs(query(buildingsCollectionRef));
                window.buildings = [];
                querySnapshot.forEach((doc) => {
                    window.buildings.push({ id: doc.id, name: doc.data().name || doc.id });
                });
                window.buildings.sort((a, b) => a.name.localeCompare(b.name)); // Sort buildings alphabetically
                console.log("loadBuildings: Buildings loaded:", window.buildings);

                window.renderBuildingSelector(); // Call global function
                if (window.buildings.length > 0) {
                    console.log("loadBuildings: Selecting first building.");
                    await window.selectBuilding(window.buildings[0].id); // Call global function
                } else {
                    console.log("loadBuildings: No buildings found, adding defaults.");
                    addBuildingSection.classList.remove('hidden'); // Show "No buildings found" message
                    buildingSelectorContainer.classList.add('hidden'); // Hide dropdown if no buildings
                    await window.addDefaultBuildings(); // Call global function
                }
            }
            catch (error) {
                console.error("Error loading buildings:", error);
                if (buildingSelect) {
                    buildingSelect.innerHTML = `<p class="text-red-500 text-center">Error loading buildings. Please try again.</p>`;
                } else {
                    console.error("buildingSelect element not found when trying to display error in loadBuildings.");
                }
            }
        }

        // Function to add default buildings
        window.addDefaultBuildings = async function() {
            console.log("addDefaultBuildings: Starting...");
            const promises = window.defaultBuildings.map(async (buildingName) => {
                const buildingId = `building-${buildingName.replace(/\s/g, '-')}`;
                const buildingDocRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/buildings`, buildingId);
                await setDoc(buildingDocRef, { name: buildingName });
            });
            await Promise.all(promises);
            console.log("addDefaultBuildings: Default buildings added. Reloading buildings...");
            await loadBuildings(); // Reload buildings after adding defaults
        }

        // Function to render building selection dropdown
        window.renderBuildingSelector = function() {
            console.log("renderBuildingSelector: Starting...");
            if (!buildingSelect) {
                console.error("renderBuildingSelector: buildingSelect is null. Cannot render.");
                return;
            }
            buildingSelect.innerHTML = '';
            window.buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                option.textContent = building.name;
                buildingSelect.appendChild(option);
            });
            if (window.selectedBuildingId) {
                buildingSelect.value = window.selectedBuildingId;
            }
            buildingSelectorContainer.classList.remove('hidden');
            addBuildingSection.classList.add('hidden'); // Hide placeholder if buildings exist
            console.log("renderBuildingSelector: Completed.");
        }

        // Function to select a building and load its units
        let unsubscribeFromUnits = null;
        window.selectBuilding = async function(buildingId) {
            console.log("selectBuilding: Starting for buildingId:", buildingId);
            if (!window.db || !window.userId) {
                console.log("selectBuilding: DB or userId not ready.");
                return;
            }

            if (unsubscribeFromUnits) {
                unsubscribeFromUnits();
                console.log("selectBuilding: Unsubscribed from previous units listener.");
            }

            window.selectedBuildingId = buildingId;
            window.selectedUnitId = null; // Reset selected unit when building changes
            currentSelectionDisplay.textContent = window.buildings.find(b => b.id === buildingId)?.name || buildingId;
            
            document.getElementById('unit-selection-section').classList.remove('hidden');
            unitSelectorContainer.classList.remove('hidden');
            addUnitSection.classList.add('hidden');
            checklistSection.classList.add('hidden');
            console.log("selectBuilding: UI sections visibility updated.");

            const unitsCollectionRef = collection(window.db, `artifacts/${window.appId}/users/${window.userId}/buildings/${buildingId}/units`);
            unsubscribeFromUnits = onSnapshot(unitsCollectionRef, (querySnapshot) => {
                console.log("onSnapshot for units: Data received.");
                window.units = [];
                querySnapshot.forEach((doc) => {
                    window.units.push({ id: doc.id, name: doc.data().name || doc.id });
                });
                window.units.sort((a, b) => a.name.localeCompare(b.name));
                window.renderUnitSelector();
                console.log("onSnapshot for units: Units rendered:", window.units);

                if (window.units.length > 0) {
                    console.log("onSnapshot for units: Selecting first unit.");
                    window.selectUnit(window.units[0].id);
                    addUnitSection.classList.add('hidden');
                } else {
                    console.log("onSnapshot for units: No units found for this building.");
                    addUnitSection.classList.remove('hidden');
                    window.currentUnitChecklistData = [];
                    window.renderChecklist();
                    window.updateDashboard();
                }
            }, (error) => {
                console.error("Error listening to units in building:", error);
                if (unitSelectorContainer) {
                    unitSelectorContainer.innerHTML = `<p class="text-red-500">Error loading units for this building. Please try again.</p>`;
                } else {
                    console.error("unitSelectorContainer element not found when trying to display error.");
                }
            });
            console.log("selectBuilding: onSnapshot listener set up.");
        }

        // Function to render unit selection dropdown
        window.renderUnitSelector = function() {
            console.log("renderUnitSelector: Starting...");
            if (!unitSelect) {
                console.error("renderUnitSelector: unitSelect is null. Cannot render.");
                return;
            }
            unitSelect.innerHTML = '';
            window.units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                option.textContent = unit.name;
                unitSelect.appendChild(option);
            });
            if (window.selectedUnitId) {
                unitSelect.value = window.selectedUnitId;
            }
            console.log("renderUnitSelector: Completed.");
        }

        // Function to select a unit and listen for its data
        let unsubscribeFromUnitChecklist = null;
        window.selectUnit = async function(unitId) {
            console.log("selectUnit: Starting for unitId:", unitId);
            if (!window.db || !window.userId || !window.selectedBuildingId) {
                console.log("selectUnit: DB, userId, or selectedBuildingId not ready.");
                return;
            }

            if (unsubscribeFromUnitChecklist) {
                unsubscribeFromUnitChecklist();
                console.log("selectUnit: Unsubscribed from previous unit checklist listener.");
            }

            window.selectedUnitId = unitId;
            const buildingName = window.buildings.find(b => b.id === window.selectedBuildingId)?.name || 'Unknown Building';
            const unitName = window.units.find(u => u.id === unitId)?.name || 'Unknown Unit';
            currentSelectionDisplay.textContent = `${buildingName} - ${unitName}`;
            checklistSection.classList.remove('hidden');
            console.log("selectUnit: Checklist section visible.");

            const unitDocRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/buildings/${window.selectedBuildingId}/units`, unitId);
            unsubscribeFromUnitChecklist = onSnapshot(unitDocRef, (docSnap) => {
                console.log("onSnapshot for unit checklist: Data received.");
                if (docSnap.exists()) {
                    window.currentUnitChecklistData = docSnap.data().checklist || [];
                    console.log("onSnapshot for unit checklist: Checklist data loaded:", window.currentUnitChecklistData);
                    window.renderChecklist();
                    window.updateDashboard();
                } else {
                    console.warn("No checklist data found for unit:", unitId);
                    window.currentUnitChecklistData = [];
                    window.renderChecklist();
                    window.updateDashboard();
                }
            }, (error) => {
                console.error("Error listening to unit checklist data:", error);
                if (checklistSection) {
                    checklistSection.innerHTML = `<p class="text-red-500 text-center">Error loading unit checklist data. Please try again.</p>`;
                } else {
                    console.error("checklistSection element not found when trying to display error.");
                }
            });
            console.log("selectUnit: onSnapshot listener set up.");
        }

        // Function to add a new building
        window.addBuilding = async function() {
            console.log("addBuilding: Called.");
            window.showModal('Enter a name for the new building:', 'prompt', ['Building Name (e.g., Building 500)'],
                async (confirmed, buildingName) => {
                if (confirmed && buildingName) {
                    console.log("addBuilding: Modal confirmed with name:", buildingName);
                    if (!window.db || !window.userId) {
                        window.showModal('Please wait for authentication to complete.', 'alert');
                        console.log("addBuilding: DB or userId not ready.");
                        return;
                    }
                    const newBuildingId = `building-${Date.now()}`;
                    const buildingDocRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/buildings`, newBuildingId);

                    try {
                        await setDoc(buildingDocRef, { name: buildingName });
                        console.log("New building added to Firestore:", buildingName);
                    } catch (error) {
                        console.error("Error adding new building:", error);
                        window.showModal("Failed to add new building. Please try again.", 'alert');
                    }
                } else if (confirmed) {
                    window.showModal('Building Name is required.', 'alert');
                    console.log("addBuilding: Building name required.");
                } else {
                    console.log("addBuilding: Modal cancelled.");
                }
            });
        }

        // Function to add a new unit to the currently selected building
        window.addUnitToCurrentBuilding = async function() {
            console.log("addUnitToCurrentBuilding called.");
            console.log("window.selectedBuildingId:", window.selectedBuildingId);

            if (!window.selectedBuildingId) {
                window.showModal('Please select a building first to add a unit.', 'alert');
                console.log("addUnitToCurrentBuilding: Alert: No building selected.");
                return;
            }

            window.showModal(`Enter a name for the new unit in ${window.buildings.find(b => b.id === window.selectedBuildingId)?.name || 'this building'}:`, 'prompt', ['Unit Name (e.g., Unit 101)'],
                async (confirmed, unitName) => {
                if (confirmed && unitName) {
                    console.log("addUnitToCurrentBuilding: Modal confirmed with unit name:", unitName);
                    if (!window.db || !window.auth.currentUser || !window.userId) {
                        window.showModal('Application not fully initialized. Please wait a moment or refresh.', 'alert');
                        console.log("addUnitToCurrentBuilding: Firebase not ready.");
                        return;
                    }

                    console.log(`Attempting to add unit '${unitName}' to building '${window.selectedBuildingId}'`);
                    const newUnitId = `unit-${Date.now()}`;
                    const unitDocRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/buildings/${window.selectedBuildingId}/units`, newUnitId);

                    try {
                        await setDoc(unitDocRef, {
                            name: unitName,
                            checklist: window.initialChecklistTemplate
                        });
                        console.log("New unit added to Firestore successfully.");
                    }
                    catch (error) {
                        console.error("Error adding new unit to Firestore:", error);
                        window.showModal("Failed to add new unit. Please try again.", 'alert');
                    }
                } else if (confirmed) {
                    window.showModal('Unit Name is required.', 'alert');
                    console.log("addUnitToCurrentBuilding: Unit name required.");
                } else {
                    console.log("addUnitToCurrentBuilding: Modal cancelled.");
                }
            });
        }

        // Function to add a new custom checklist item
        window.addNewChecklistItem = function() {
            console.log("addNewChecklistItem: Called.");
            if (!window.selectedUnitId) {
                window.showModal('Please select a unit first to add a custom item.', 'alert');
                console.log("addNewChecklistItem: Alert: No unit selected.");
                return;
            }

            window.showModal('Add New Checklist Item', 'prompt', ['Item Name (e.g., Living Room Window)', 'Issue Description', 'Area (e.g., Kitchen, Bathroom)'],
                async (confirmed, itemName, issueDesc, area) => {
                if (confirmed && itemName && issueDesc && area) {
                    console.log("addNewChecklistItem: Modal confirmed with details.");
                    if (!window.db || !window.userId || !window.selectedBuildingId || !window.selectedUnitId) {
                        window.showModal('Application not fully initialized. Please wait a moment or refresh.', 'alert');
                        console.log("addNewChecklistItem: Firebase not ready.");
                        return;
                    }

                    const newItem = {
                        id: Date.now(), // Unique ID
                        area: area.trim(),
                        item: itemName.trim(),
                        issue: issueDesc.trim(),
                        priority: 'Medium', // Default
                        cost: 0, // Default
                        notes: '', // Default
                        status: 'To Do' // Default
                    };

                    // Add to current data and save
                    window.currentUnitChecklistData.push(newItem);
                    const unitDocRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/buildings/${window.selectedBuildingId}/units`, window.selectedUnitId);
                    try {
                        await setDoc(unitDocRef, { checklist: window.currentUnitChecklistData }, { merge: true });
                        console.log("New custom item added to Firestore successfully:", newItem);
                        window.renderChecklist();
                        window.updateDashboard();
                        window.renderFilters();
                    } catch (error) {
                        console.error("Error saving new custom item to Firestore:", error);
                        window.showModal("Failed to add custom item. Please try again.", 'alert');
                    }
                } else if (confirmed) {
                    window.showModal('Item Name, Issue Description, and Area are required.', 'alert');
                    console.log("addNewChecklistItem: Required fields missing.");
                } else {
                    console.log("addNewChecklistItem: Modal cancelled.");
                }
            });
        };


        // Function to save changes to a checklist item in Firestore
        window.saveChecklistItem = async function(id, field, value) {
            console.log(`saveChecklistItem: Saving item ${id}, field ${field}, value ${value}`);
            if (!window.db || !window.userId || !window.selectedBuildingId || !window.selectedUnitId) {
                console.log("saveChecklistItem: Firebase or selection not ready.");
                return;
            }

            const itemIndex = window.currentUnitChecklistData.findIndex(item => item.id === id);
            if (itemIndex > -1) {
                window.currentUnitChecklistData[itemIndex][field] = value;
                const unitDocRef = doc(window.db, `artifacts/${window.appId}/users/${window.userId}/buildings/${window.selectedBuildingId}/units`, window.selectedUnitId);
                try {
                    await setDoc(unitDocRef, {
                        checklist: window.currentUnitChecklistData
                    }, { merge: true });
                    console.log("saveChecklistItem: Item saved successfully.");
                } catch (error) {
                    console.error("Error saving checklist item:", error);
                }
            } else {
                console.log("saveChecklistItem: Item not found in current data.");
            }
        }

        // --- DOMContentLoaded Event Listener ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded: All HTML parsed. Initializing DOM element references and event listeners.");

            // Assign DOM element references
            buildingSelect = document.getElementById('building-select');
            addBuildingBtn = document.getElementById('add-building-btn');
            buildingSelectorContainer = document.getElementById('building-selector-container');
            addBuildingSection = document.getElementById('add-building-section');
            currentSelectionDisplay = document.getElementById('current-selection-display');

            unitSelect = document.getElementById('unit-select');
            addUnitBtn = document.getElementById('add-unit-btn');
            unitSelectorContainer = document.getElementById('unit-selector-container');
            addUnitSection = document.getElementById('add-unit-section');
            addUnitBtnPlaceholder = document.getElementById('add-unit-btn-placeholder');

            checklistSection = document.getElementById('checklist-section');
            totalItemsDisplay = document.getElementById('total-items');
            completedItemsDisplay = document.getElementById('completed-items');
            pendingItemsDisplay = document.getElementById('pending-items');
            totalCostDisplay = document.getElementById('total-cost');
            statusChartCanvas = document.getElementById('statusChart');

            filtersContainer = document.getElementById('filters');
            checklistContainer = document.getElementById('checklist-items');
            addCustomItemBtn = document.getElementById('add-custom-item-btn');

            modalMessage = document.getElementById('modal-message');
            modalInput1 = document.getElementById('modal-input-1');
            modalInput2 = document.getElementById('modal-input-2');
            modalInput3 = document.getElementById('modal-input-3');
            modalCancelBtn = document.getElementById('modal-cancel-btn');
            modalOkBtn = document.getElementById('modal-ok-btn');
            customModal = document.getElementById('custom-modal');

            console.log("DOMContentLoaded: DOM element references assigned.");

            // Attach event listeners after DOM is ready
            buildingSelect.addEventListener('change', (e) => {
                window.selectBuilding(e.target.value);
            });
            addBuildingBtn.addEventListener('click', window.addBuilding);
            unitSelect.addEventListener('change', (e) => {
                window.selectUnit(e.target.value);
            });
            addUnitBtnPlaceholder.addEventListener('click', (e) => {
                window.addUnitToCurrentBuilding();
            });
            addUnitBtn.addEventListener('click', (e) => {
                window.addUnitToCurrentBuilding();
            });
            addCustomItemBtn.addEventListener('click', window.addNewChecklistItem);
            filtersContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    window.currentFilter = e.target.dataset.filter; // Assign to window.currentFilter
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('bg-slate-800', 'text-white');
                        btn.classList.add('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
                    });
                    e.target.classList.add('bg-slate-800', 'text-white');
                    e.target.classList.remove('bg-slate-200', 'text-slate-700', 'hover:bg-slate-300');
                    window.renderChecklist();
                }
            });
            checklistContainer.addEventListener('change', (e) => {
                if (e.target.dataset.id) {
                    const id = parseInt(e.target.dataset.id);
                    const field = e.target.dataset.field;
                    let value = e.target.value;

                    if (field === 'cost') {
                        value = parseFloat(value) || 0;
                    }
                    window.saveChecklistItem(id, field, value);
                }
            });
            checklistContainer.addEventListener('click', (e) => {
                if (e.target.dataset.action) {
                    const id = parseInt(e.target.dataset.id);
                    const item = window.currentUnitChecklistData.find(i => i.id === id);
                    const responseDiv = document.getElementById(`gemini-response-${item.id}`);
                    responseDiv.classList.remove('hidden');

                    if (e.target.dataset.action === 'get-ideas') {
                        const prompt = `Generate a few creative renovation ideas for a ${item.item} in the ${item.area} area of an apartment. Focus on modern, cost-effective, and practical suggestions. Provide a concise list.`;
                        callGeminiAPI(prompt, item.id);
                    } else if (e.target.dataset.action === 'expand-notes') {
                        const prompt = `Based on the renovation item '${item.item}' and its issue '${item.issue}', draft a detailed action plan or notes for fixing/renovating it. Include steps, considerations, and potential tools/materials. Be concise and actionable.`;
                        callGeminiAPI(prompt, item.id);
                    }
                }
            });

            modalOkBtn.addEventListener('click', () => {
                const input1Val = modalInput1.value;
                const input2Val = modalInput2.value;
                const input3Val = modalInput3.value;
                window.hideModal();
                if (window.modalCallback) { // Use window.modalCallback
                    window.modalCallback(true, input1Val, input2Val, input3Val);
                }
            });

            modalCancelBtn.addEventListener('click', () => {
                window.hideModal();
                if (window.modalCallback) { // Use window.modalCallback
                    window.modalCallback(false);
                }
            });

            console.log("DOMContentLoaded: Event listeners attached.");

            // Initialize Firebase
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            
            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            console.log("DOMContentLoaded: Firebase initialized.");

            onAuthStateChanged(window.auth, async (user) => {
                console.log("onAuthStateChanged: Auth state changed. User:", user ? user.uid : "null");
                if (user) {
                    window.userId = user.uid;
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(window.auth, __initial_auth_token);
                            console.log("onAuthStateChanged: Signed in with custom token.");
                        } else {
                            await signInAnonymously(window.auth);
                            console.log("onAuthStateChanged: Signed in anonymously.");
                        }
                        window.userId = window.auth.currentUser.uid;
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        if (buildingSelect) {
                            buildingSelect.innerHTML = `<p class="text-red-500 text-center">Authentication failed. Please refresh the page.</p>`;
                        } else {
                            console.error("buildingSelect element not found during auth error display.");
                        }
                        return;
                    }
                }
                if (window.userId) {
                    console.log("onAuthStateChanged: User ID set. Loading buildings...");
                    await loadBuildings();
                }
            });

            // Initial rendering of filters and showing the building selection section
            // window.currentFilter is already initialized globally.
            window.renderFilters();
            document.getElementById('building-selection-section').classList.remove('hidden');
            console.log("DOMContentLoaded: Initial filters rendered and building section shown.");
        });
    </script>
</body>
</html>
